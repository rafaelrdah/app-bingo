<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marcador de Bingo</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007bff">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #222;
            color: #eee;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        .controles-topo {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 500px;
            justify-content: space-between;
        }

        button, .input-file-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button:hover, .input-file-btn:hover { background-color: #0056b3; }
        #btnDesfazer { background-color: #dc3545; }
        #btnDesfazer:hover { background-color: #c82333; }
        #btnDesfazerVirtual { background-color: #dc3545; }
        #btnDesfazerVirtual:hover { background-color: #c82333; }
        #btnLimpar { background-color: #ffc107; color: #212529; }
        #btnLimpar:hover { background-color: #e0a800; }

        .input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0; top: 0; opacity: 0; cursor: pointer;
        }

        /* --- MODO MANUAL (PINCEL) --- */
        #container-manual {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            align-items: center;
        }

        canvas {
            width: 90vw;
            height: 90vw;
            max-width: 500px;
            max-height: 500px;
            border: 3px solid #fff;
            border-radius: 12px;
            background-color: #fff;
            touch-action: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .controles-baixo {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: flex-end; 
            margin-top: 15px;
        }

        .ferramentas-pincel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #333;
            padding: 10px 15px 5px 15px;
            border-radius: 20px;
        }

        .seletor-tamanho {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .btn-tamanho {
            background: none;
            border: 2px solid transparent;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .pincel-icone {
            background-color: #ff0000;
            border-radius: 50%;
            display: inline-block;
            opacity: 0.8;
        }

        .btn-tamanho.ativo {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #ffc107;
        }

        .slider-personalizado {
            width: 100%;
            cursor: pointer;
            height: 6px;
            background: #555;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 22px; 
        }

        .slider-personalizado::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px; 
            height: 28px; 
            border-radius: 4px;
            background: #ff0000;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.6);
            transform: translateY(9px);
        }

        .slider-personalizado::-moz-range-thumb {
            width: 14px;
            height: 28px;
            border-radius: 4px;
            background: #ff0000;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.6);
            transform: translateY(9px);
        }

        /* --- MODO VIRTUAL PADR√ÉO (MOBILE - MENOR) --- */
        #container-virtual {
            display: none;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }

        .cartela-virtual-wrapper {
            background-color: #2db3e8; 
            padding: 12px;
            border-radius: 4px;
            width: 82vw; 
            max-width: 400px; 
            box-sizing: border-box;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .cartela-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        .nome-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
        }

        .nome-jogador {
            background-color: #fff;
            color: #2db3e8;
            padding: 3px 18px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px; 
            text-transform: uppercase;
            font-family: serif;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        
        .nome-jogador:active {
            transform: scale(0.95);
        }

        .letras-bingo {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            color: #fff;
            font-size: 34px; 
            font-weight: bold;
            font-family: serif;
        }

        .grade-virtual {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px; 
            width: 100%;
            aspect-ratio: 1 / 1;
            box-sizing: border-box;
            background-color: #2db3e8; 
        }

        .btn-numero {
            background-color: #fff;
            border: none;
            border-radius: 2px;
            font-size: 21px; 
            font-family: serif;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            padding: 0;
            overflow: hidden;
        }

        .btn-numero span {
            position: relative;
            z-index: 1;
        }

        /* Cursor default para a estrela n√£o parecer clic√°vel */
        .btn-numero.livre {
            background-color: #2db3e8;
            color: #fff;
            font-size: 30px;
            cursor: default; 
        }

        .btn-numero::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85%; 
            height: 85%;
            border-radius: 50%;
            background-color: rgba(255, 0, 0, 0.85); 
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 2;
        }

        .btn-numero.marcado::after {
            opacity: 1;
        }

        .controles-baixo-virtual {
            display: flex;
            width: 82vw; 
            max-width: 400px;
            justify-content: space-between; 
            margin-top: 15px;
        }

        .btn-mudar-modo {
            background-color: #6c757d;
            font-size: 14px;
            padding: 8px 15px;
            border-radius: 8px;
        }
        .btn-mudar-modo:hover { background-color: #5a6268; }

        /* --- TELAS DE CARREGAMENTO E CORTE --- */
        #loading-qr {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.90);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #cropper-modal {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .cropper-container-wrapper {
            width: 100%;
            max-width: 500px;
            height: 60vh; 
            background-color: #333;
            margin-bottom: 20px;
        }

        #image-to-crop {
            display: block;
            max-width: 100%;
        }

        .botoes-corte {
            display: flex;
            gap: 15px;
        }

        /* ==========================================================
           M√ÅGICA DA RESPONSIVIDADE: DESKTOP / PC (ECR√ÉS MAIORES QUE 600px)
           ========================================================== */
        @media (min-width: 600px) {
            .cartela-virtual-wrapper {
                width: 90vw; 
                max-width: 500px; 
            }
            .nome-jogador {
                font-size: 14px; 
                padding: 3px 20px;
            }
            .letras-bingo {
                font-size: 38px; 
            }
            .btn-numero {
                font-size: 26px; 
            }
            .btn-numero.livre {
                font-size: 36px;
            }
            .controles-baixo-virtual {
                width: 90vw; 
                max-width: 500px; 
            }
        }
    </style>
</head>
<body>

    <div id="loading-qr">
        <div class="spinner"></div>
        <h3 style="margin:0;">A ler Cartela...</h3>
    </div>

    <div class="controles-topo">
        <div class="input-wrapper">
            <button class="input-file-btn">üìÅ Carregar cartela</button>
            <input type="file" id="carregarImagem" accept="image/*">
        </div>
        <button id="btnLimpar">Limpar Tudo üóëÔ∏è</button>
    </div>

    <div id="container-virtual">
        <div class="cartela-virtual-wrapper">
            <div class="cartela-header">
                <div class="nome-container">
                    <div class="nome-jogador" id="nomeDisplay" onclick="editarNome()" title="Toque para corrigir o nome">JOGADOR</div>
                </div>
                <div class="letras-bingo">
                    <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
                </div>
            </div>
            <div class="grade-virtual" id="grade-botoes"></div>
        </div>
        
        <div class="controles-baixo-virtual">
            <button class="btn-mudar-modo" id="btnMudarManual">‚úèÔ∏è Mudar para Pincel</button>
            <button id="btnDesfazerVirtual">Desfazer ‚Ü©Ô∏è</button>
        </div>
    </div>

    <div id="container-manual">
        <canvas id="canvas" width="1000" height="1000"></canvas>

        <div class="controles-baixo">
            <div class="ferramentas-pincel">
                <div class="seletor-tamanho">
                    <button class="btn-tamanho" onclick="mudarTamanho(7, this)"><span class="pincel-icone" style="width: 5px; height: 5px;"></span></button>
                    <button class="btn-tamanho ativo" onclick="mudarTamanho(20, this)"><span class="pincel-icone" style="width: 12px; height: 12px;"></span></button>
                    <button class="btn-tamanho" onclick="mudarTamanho(40, this)"><span class="pincel-icone" style="width: 22px; height: 22px;"></span></button>
                </div>
                <input type="range" id="sliderPincel" class="slider-personalizado" min="5" max="115" value="20">
            </div>
            <button id="btnDesfazer">Desfazer ‚Ü©Ô∏è</button>
        </div>
    </div>

    <div id="cropper-modal">
        <h3 style="margin-top:0; color:white; text-align:center;">Ajuste a sua Cartela</h3>
        <div class="cropper-container-wrapper"><img id="image-to-crop" src=""></div>
        <div class="botoes-corte">
            <button id="btn-cancelar-corte" style="background-color: #6c757d;">Cancelar ‚ùå</button>
            <button id="btn-confirmar-corte" style="background-color: #28a745;">Cortar e Usar ‚úÖ</button>
        </div>
    </div>

    <script>
        let modoAtual = 'manual';
        let imagemOriginalSrc = null;

        const inputImagem = document.getElementById('carregarImagem');
        const btnLimpar = document.getElementById('btnLimpar');
        const loadingQr = document.getElementById('loading-qr');
        const containerVirtual = document.getElementById('container-virtual');
        const gradeBotoes = document.getElementById('grade-botoes');
        const nomeDisplay = document.getElementById('nomeDisplay');
        const btnMudarManual = document.getElementById('btnMudarManual');
        const btnDesfazerVirtual = document.getElementById('btnDesfazerVirtual');
        const containerManual = document.getElementById('container-manual');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnDesfazer = document.getElementById('btnDesfazer');
        const sliderPincel = document.getElementById('sliderPincel');
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const btnConfirmarCorte = document.getElementById('btn-confirmar-corte');
        const btnCancelarCorte = document.getElementById('btn-cancelar-corte');
        
        let cropper;
        let desenhando = false;
        
        let historico = []; 
        let historicoVirtual = []; 

        ctx.strokeStyle = "rgba(255, 0, 0, 0.85)";
        ctx.lineWidth = 20; 
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        function mudarTamanho(novoTamanho, elemento) {
            ctx.lineWidth = novoTamanho;
            sliderPincel.value = novoTamanho;
            document.querySelectorAll('.btn-tamanho').forEach(btn => btn.classList.remove('ativo'));
            elemento.classList.add('ativo');
        }

        sliderPincel.addEventListener('input', (e) => {
            ctx.lineWidth = e.target.value;
            document.querySelectorAll('.btn-tamanho').forEach(btn => btn.classList.remove('ativo'));
        });

        function editarNome() {
            let nomeAtual = nomeDisplay.innerText;
            if (nomeAtual === "JOGADOR") nomeAtual = "";
            
            const novoNome = prompt("Corrija o seu nome para a cartela:", nomeAtual);
            if (novoNome !== null && novoNome.trim() !== "") {
                nomeDisplay.innerText = novoNome.trim().toUpperCase();
                localStorage.setItem('bingoNomeVirtual', nomeDisplay.innerText);
            }
        }

        function lerQRCode(src, callback) {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = img.width;
                cvs.height = img.height;
                const ctxTemp = cvs.getContext('2d');
                ctxTemp.drawImage(img, 0, 0, cvs.width, cvs.height);
                
                const imageData = ctxTemp.getImageData(0, 0, cvs.width, cvs.height);
                const codigo = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (codigo) {
                    callback({ sucesso: true, dados: codigo.data });
                } else {
                    callback({ sucesso: false });
                }
            };
            img.src = src;
        }

        inputImagem.addEventListener('change', function(e) {
            if (!e.target.files[0]) return;
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                imagemOriginalSrc = event.target.result;
                loadingQr.style.display = 'flex';
                
                lerQRCode(imagemOriginalSrc, (resultado) => {
                    loadingQr.style.display = 'none';
                    
                    if(resultado.sucesso) {
                        try {
                            const partes = resultado.dados.split('|');
                            if(partes.length >= 3) {
                                const numeros = partes[1].split(',').map(Number);
                                const nome = partes[2];
                                
                                if(numeros.length === 24) {
                                    iniciarModoVirtual(numeros, nome);
                                } else {
                                    iniciarModoManualPlanoB(imagemOriginalSrc);
                                }
                            } else {
                                iniciarModoManualPlanoB(imagemOriginalSrc);
                            }
                        } catch (err) {
                            iniciarModoManualPlanoB(imagemOriginalSrc);
                        }
                    } else {
                        iniciarModoManualPlanoB(imagemOriginalSrc);
                    }
                });
            }
            reader.readAsDataURL(file);
            e.target.value = ''; 
        });

        function guardarEstadoNoHistoricoVirtual() {
            const botoes = document.querySelectorAll('.btn-numero');
            const estado = Array.from(botoes).map(btn => btn.classList.contains('marcado'));
            historicoVirtual.push(JSON.stringify(estado));
            // Persiste o hist√≥rico virtual no armazenamento local
            localStorage.setItem('bingoHistoricoVirtual', JSON.stringify(historicoVirtual));
        }

        btnDesfazerVirtual.addEventListener('click', () => {
            if (historicoVirtual.length > 0) {
                const estadoAnteriorStr = historicoVirtual.pop();
                const estadoAnterior = JSON.parse(estadoAnteriorStr);
                
                const botoes = document.querySelectorAll('.btn-numero');
                botoes.forEach((btn, index) => {
                    if (estadoAnterior[index]) {
                        btn.classList.add('marcado');
                    } else {
                        btn.classList.remove('marcado');
                    }
                });
                
                // Atualiza o hist√≥rico persistente depois do "Desfazer"
                localStorage.setItem('bingoHistoricoVirtual', JSON.stringify(historicoVirtual));
                salvarEstadoVirtual(); 
            }
        });

        function iniciarModoVirtual(numeros, nome) {
            modoAtual = 'virtual';
            containerManual.style.display = 'none';
            containerVirtual.style.display = 'flex';
            
            nomeDisplay.innerText = nome;
            gradeBotoes.innerHTML = '';
            
            // Limpa o hist√≥rico virtual de cartelas antigas
            historicoVirtual = []; 
            localStorage.removeItem('bingoHistoricoVirtual');
            
            let numIndex = 0;

            for(let i = 0; i < 25; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn-numero';
                btn.dataset.indice = i;

                const spanText = document.createElement('span');

                if(i === 12) {
                    spanText.innerText = '‚òÖ'; 
                    btn.classList.add('livre');
                } else {
                    spanText.innerText = numeros[numIndex];
                    numIndex++;
                }

                btn.appendChild(spanText);

                btn.addEventListener('click', function() {
                    // TRAVA NOVA: S√≥ marca se n√£o estiver marcado E n√£o for a casa livre
                    if (!this.classList.contains('marcado') && !this.classList.contains('livre')) {
                        guardarEstadoNoHistoricoVirtual();
                        this.classList.add('marcado');
                        salvarEstadoVirtual();
                    }
                });
                gradeBotoes.appendChild(btn);
            }
            
            localStorage.setItem('bingoModo', 'virtual');
            localStorage.setItem('bingoNomeVirtual', nome);
            salvarEstadoVirtual();
        }

        function salvarEstadoVirtual() {
            const botoes = document.querySelectorAll('.btn-numero');
            const estado = Array.from(botoes).map(btn => ({
                texto: btn.querySelector('span').innerText,
                marcado: btn.classList.contains('marcado'),
                livre: btn.classList.contains('livre')
            }));
            localStorage.setItem('bingoVirtual', JSON.stringify(estado));
        }

        function restaurarEstadoVirtual(estadoSalvo, nomeSalvo) {
            modoAtual = 'virtual';
            containerManual.style.display = 'none';
            containerVirtual.style.display = 'flex';
            
            nomeDisplay.innerText = nomeSalvo || "JOGADOR";
            gradeBotoes.innerHTML = '';
            
            // Tenta recuperar o hist√≥rico salvo ou inicia um novo
            const histSalvo = localStorage.getItem('bingoHistoricoVirtual');
            if (histSalvo) {
                historicoVirtual = JSON.parse(histSalvo);
            } else {
                historicoVirtual = [];
            }

            const estado = JSON.parse(estadoSalvo);
            estado.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-numero';
                btn.dataset.indice = i;
                
                const spanText = document.createElement('span');
                spanText.innerText = item.texto;
                btn.appendChild(spanText);

                if(item.livre) btn.classList.add('livre');
                if(item.marcado) btn.classList.add('marcado');
                
                btn.addEventListener('click', function() {
                    // TRAVA NOVA NA RESTAURA√á√ÉO TAMB√âM
                    if (!this.classList.contains('marcado') && !this.classList.contains('livre')) {
                        guardarEstadoNoHistoricoVirtual(); 
                        this.classList.add('marcado');
                        salvarEstadoVirtual();
                    }
                });
                gradeBotoes.appendChild(btn);
            });
        }

        btnMudarManual.addEventListener('click', () => {
            if(confirm("Aten√ß√£o!\nAo mudar para o Modo Pincel, perder√° as marca√ß√µes virtuais atuais.\n\nDeseja continuar?")) {
                if(imagemOriginalSrc) {
                    iniciarModoManualPlanoB(imagemOriginalSrc);
                }
            }
        });

        function iniciarModoManualPlanoB(srcImagem) {
            modoAtual = 'manual';
            containerVirtual.style.display = 'none';
            containerManual.style.display = 'flex';
            localStorage.setItem('bingoModo', 'manual');

            const tempImg = new Image();
            tempImg.onload = function() {
                if (tempImg.width === tempImg.height) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
                    historico = [];
                    salvarEstadoManual();
                } else {
                    imageToCrop.src = srcImagem;
                    cropperModal.style.display = 'flex';
                    if (cropper) { cropper.destroy(); }
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                        dragMode: 'move',
                        background: false
                    });
                }
            };
            tempImg.src = srcImagem;
        }

        btnConfirmarCorte.addEventListener('click', () => {
            const canvasCortado = cropper.getCroppedCanvas({ width: 1000, height: 1000 });
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(canvasCortado, 0, 0, canvas.width, canvas.height);
            cropperModal.style.display = 'none';
            historico = [];
            salvarEstadoManual();
        });

        btnCancelarCorte.addEventListener('click', () => {
            cropperModal.style.display = 'none';
            if (cropper) { cropper.destroy(); }
        });

        function getPosicaoManual(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
        }

        function iniciarDesenho(e) {
            if(modoAtual !== 'manual') return;
            e.preventDefault();
            desenhando = true;
            const pos = getPosicaoManual(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function desenhar(e) {
            if (!desenhando || modoAtual !== 'manual') return;
            e.preventDefault();
            const pos = getPosicaoManual(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function pararDesenho(e) {
            if (desenhando && modoAtual === 'manual') {
                e.preventDefault();
                desenhando = false;
                ctx.closePath();
                salvarEstadoManual();
            }
        }

        canvas.addEventListener('touchstart', iniciarDesenho, { passive: false });
        canvas.addEventListener('touchmove', desenhar, { passive: false });
        canvas.addEventListener('touchend', pararDesenho, { passive: false });
        canvas.addEventListener('touchcancel', pararDesenho, { passive: false });
        canvas.addEventListener('mousedown', iniciarDesenho);
        canvas.addEventListener('mousemove', desenhar);
        canvas.addEventListener('mouseup', pararDesenho);
        canvas.addEventListener('mouseout', pararDesenho);

        function salvarEstadoManual() {
            const estadoAtual = canvas.toDataURL();
            historico.push(estadoAtual);
            try { localStorage.setItem('bingoSalvoManual', estadoAtual); } catch (e) {}
        }

        btnDesfazer.addEventListener('click', () => {
            if (historico.length > 1) {
                historico.pop();
                const estadoAnterior = historico[historico.length - 1];
                restaurarImagemManual(estadoAnterior);
                localStorage.setItem('bingoSalvoManual', estadoAnterior);
            }
        });

        // BOT√ÉO LIMPAR TUDO AGORA FAZ RESET TOTAL
        btnLimpar.addEventListener('click', () => {
            if (confirm("Tem a certeza que deseja limpar tudo e remover a cartela atual?")) {
                
                // 1. Limpa TODOS os dados locais gravados
                localStorage.removeItem('bingoVirtual');
                localStorage.removeItem('bingoNomeVirtual');
                localStorage.removeItem('bingoHistoricoVirtual');
                localStorage.removeItem('bingoModo');
                localStorage.removeItem('bingoSalvoManual');
                
                // 2. Limpa a mem√≥ria RAM
                historicoVirtual = [];
                historico = [];
                imagemOriginalSrc = null;
                
                // 3. Volta o site para o estado de f√°brica (Canvas Vazio)
                modoAtual = 'manual';
                containerVirtual.style.display = 'none';
                containerManual.style.display = 'flex';
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });

        function restaurarImagemManual(src) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = "rgba(255, 0, 0, 0.85)";
                ctx.lineWidth = sliderPincel.value;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
            };
            img.src = src;
        }

        window.onload = () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let reg of registrations) reg.unregister();
                });
            }

            const modoGuardado = localStorage.getItem('bingoModo');
            if (modoGuardado === 'virtual') {
                const estadoVirtual = localStorage.getItem('bingoVirtual');
                const nomeVirtual = localStorage.getItem('bingoNomeVirtual');
                if(estadoVirtual) restaurarEstadoVirtual(estadoVirtual, nomeVirtual);
            } else if (modoGuardado === 'manual' || !modoGuardado) {
                modoAtual = 'manual';
                containerVirtual.style.display = 'none';
                containerManual.style.display = 'flex';
                const salvoManual = localStorage.getItem('bingoSalvoManual');
                if (salvoManual) {
                    restaurarImagemManual(salvoManual);
                    historico.push(salvoManual);
                }
            }
        };
    </script>
</body>
</html>
